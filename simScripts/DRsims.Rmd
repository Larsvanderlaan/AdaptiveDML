---
title: "simsDR"
output: html_document
date: '2023-07-05'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}


out <- do_sims(2000, 1, 20)
ATE <- 1.371726
out$ATE <- 1.371726
out[, coverage := CI_left <= ATE & CI_right >= ATE]
out
results <- unique(out[, .( se = sd(estimate), bias = abs(estimate - ATE), coverage = mean(coverage)), by = c("misp", "estimator")])

results
```

```{r}
library(data.table)

n_list <- c(500, 1000, 2000, 3000, 4000, 5000)
pos_list <- c(0.5, 1, 2, 3)
misp_list <- 1:4
results <-
  rbindlist(unlist(lapply(n_list, function(n){
    unlist(lapply(pos_list, function(pos) {
  lapply(misp_list, function(misp) {
    try({
      dat <-  get_data(100000, pos)
      pi <-dat$pi
      ATE <- dat$ATE
      pos_const <- signif(min(pi, 1-pi),1)
    key <- paste0("DR_iter=", "5000", "_n=", n, "_pos=", pos, "_mode=", misp )
   data <- fread(paste0("simResultsDR/sim_results_", key, ".csv"))
   dat1 <- data[, grep( "audrie", colnames(data)), with = F ]
   colnames(dat1) <- c("estimate", "CI_left", "CI_right")
   dat1$method <- "auDRI"
   dat1$iter <- 1:nrow(dat1)
   dat2 <- data[, grep( "AIPW", colnames(data)), with = F]
   colnames(dat2) <- c("estimate", "CI_left", "CI_right")
   dat2$method <- "AIPW"
   dat2$iter <- 1:nrow(dat2)
    data <- rbind(dat1, dat2)
   data$n <- n
   data$pos <- pos_const
   data$misp <- misp
   data$ATE <- ATE
   return(data)
    })
    return(data.table())
  })
}), recursive = F)
}), recursive = F))


results[, coverage := CI_left <= ATE & CI_right >= ATE]
results <- unique(results[, .( se = sd(estimate), bias = abs(estimate - ATE), coverage = mean(coverage)), by = c("pos", "n", "misp", "method")])
results[, rmse := sqrt(bias^2 + se^2)]
results <- results[!duplicated(results[, c("pos", "n", "misp", "method"), with = F]),]

 

```



```{r}

results[n >= 1000 & pos == 4e-02]

```
