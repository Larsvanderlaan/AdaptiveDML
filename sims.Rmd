---
title: "sims"
output: html_document
date: '2023-04-11'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
 

```{r}
n <- 1000
 
 data_list$W <- data_list$W[,c(1,2,3,4,5)]
boot_est <- sapply(1:2, function(i) {
  data_list <- data_list
  index <- sample(1:n, n, replace = T)
  W <- data_list$W[index, ]
 Y <- data_list$Y[index]
  A <- data_list$A[index]
  X <-  cbind(1, W[,c(1,2,4,5)], A, A * W[,c(1,3,5)])
  beta <- coef(glm.fit(
   X
                       , Y))
 
 X1 <- cbind(1, W[,c(1,2,4,5)], 1, 1 * W[,c(1,3,5)])
 X0 <-  cbind(1, W[,c(1,2,4,5)], 0, 0 * W[,c(1,3,5)])
 alpha <- X %*% solve(t(X) %*% X/n, colMeans(X1 - X0))
  IF_Y_map <- function(...) {
    x_basis <- X
    n <- nrow(W)
   #M <- x_proj %*% solve((t(x_proj) %*% x_proj) / n, t(x_proj))
    alpha <- x_basis %*% solve(t(x_basis) %*% x_basis/n, colMeans(X1 - X0)  )
    IF <- alpha * (Y - x_basis %*% beta)
  }
 
  print( sd( alpha * (Y - X %*% beta)    + X1 %*% beta - X0 %*% beta )/sqrt(n))

  return(mean( X1 %*% beta - X0 %*% beta))
})

sd(boot_est)
```

```{r}
 
 
   data_list <- get_data(1000, 1, FALSE)
    fit_T <- fit_hal_cate(data_list$W, data_list$A, data_list$Y,  max_degree = 1, num_knots = 1, smoothness_orders = 1,max_degree_cate =1, num_knots_cate = 1, smoothness_orders_cate = 1,    screen_variables = TRUE, fit_control = list(parallel = TRUE))
  ate_T <- unlist(inference_cate(fit_T))
ate_T

```


```{r}
sim_results <- rbindlist(lapply(1:5, function(iter) {
    print(paste0("Iteration number: ", iter))
    try({
    data_list <- get_data(1000, 1, FALSE)
    fit_T <- fit_hal_cate(data_list$W, data_list$A, data_list$Y,  max_degree = 1, num_knots = 1, smoothness_orders = 1,max_degree_cate =1, num_knots_cate = 1, smoothness_orders_cate = 1,    screen_variables = TRUE, fit_control = list(parallel = TRUE))
  ate_T <- unlist(inference_cate(fit_T))
    return(as.data.table(ate_T))
    })
    return(data.table())
  }))

```

```{r}
sd(as.numeric(sim_results$ate_T[c(2,2+ 5*1:round((229/6)))] ))
sd(as.numeric(sim_results$ate_T[c(2,2+ 5*1:round((229/6)))] ))

left <- as.numeric(sim_results$ate_T[c(4,4+ 5*1:round((229/6)))] )
right <- as.numeric(sim_results$ate_T[c(5,5+ 5*1:round((229/6)))] )
table(1 <= right & 1 >= left )
```

 

```{r}

library(data.table)
#data <- do_sims(20, 2000, 1, F)
 #data <- as.data.table(data)
 
data <- fread("simResults/sim_results_iter=1000_n=1000_pos=3_hard=FALSE.csv")
#data <- out
data <- as.data.table(out)
 data[, mean(as.numeric(coef) ), by = method ]
  data[, mean(as.numeric(se) ), by = method ]
  
  data[, sd(as.numeric(coef) ), by = method ]
 data[, mean(as.numeric(CI_left) <= 1 & as.numeric(CI_right) >= 1), by = method ]
```
